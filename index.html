<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EnergyControl ‚Äî Dashboard Final</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Agregamos Leaflet (OpenStreetMap) - Sin API key requerida -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Estilos adicionales para la geolocalizaci√≥n */
    .map-container {
      height: 300px;
      width: 100%;
      margin-top: 15px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--accent);
      background: var(--card2);
    }
    
    .mini-map-container {
      height: 200px;
      width: 100%;
      margin-top: 10px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--accent);
      background: var(--card2);
    }
    
    .location-section {
      margin-top: 15px;
      padding: 15px;
      background: var(--card2);
      border-radius: 8px;
      border: 1px solid var(--accent);
    }
    
    .location-info {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .location-coords {
      flex: 1;
    }
    
    .location-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .location-btn {
      padding: 8px 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .location-btn:hover {
      background: var(--accent-dark);
    }
    
    .location-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .map-modal .modal {
      max-width: 90%;
      width: 800px;
    }
    
    .client-location {
      margin-top: 15px;
      padding: 12px;
      background: var(--card2);
      border-radius: 6px;
      border-left: 3px solid var(--accent);
      color: #e6f7f7;
    }
    
    .client-map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .view-map-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 8px;
    }
    
    .view-map-btn:hover {
      background: var(--accent-dark, #3a8e8c);
    }
    
    .leaflet-container {
      font-family: inherit;
    }
    
    .location-current {
      margin-top: 10px;
      padding: 8px;
      background: rgba(110,240,138,0.08);
      border-radius: 4px;
      font-size: 0.9rem;
      color: var(--alert-green);
    }
    
    .no-location-message {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,214,107,0.08);
      border-radius: 4px;
      border-left: 3px solid var(--alert-amber);
      font-size: 0.9rem;
      color: #ffd66b;
    }
    
    .location-coordinates {
      font-size: 0.8rem;
      color: #666;
      margin-top: 5px;
    }
    
    .location-coords input,
    .location-coords {
      background: var(--card);
      color: #e6f7f7;
      border: 1px solid var(--accent);
    }
  </style>
</head>
<body>
  <header>üîã ENERGYCONTROL ‚Äî Dashboard Final</header>
  
  <!-- Alerta de conexi√≥n -->
  <div id="conexionAlert">
    <div class="conexion-alert-icon">‚ö†Ô∏è</div>
    <div class="conexion-alert-content">
      <strong id="conexionAlertTitle">Problema de conexi√≥n</strong>
      <div id="conexionAlertMessage">No se pueden obtener datos del servidor Arduino</div>
    </div>
    <button class="conexion-alert-close" id="conexionAlertClose">‚úï</button>
  </div>
  
  <div id="alertBar" aria-live="polite" style="display: none;">
    <div class="alertItem"><span class="dot green" id="alertOverallDot"></span><strong id="alertOverallText">NORMAL</strong></div>
    <div class="alertItem"><span class="dot" id="cellAlertDot"></span><span id="cellAlertText">Celdas OK</span></div>
    <div class="alertItem"><span class="dot" id="tempAlertDot"></span><span id="tempAlertText">Temp OK</span></div>
    <div class="alertItem"><span class="dot" id="socAlertDot"></span><span id="socAlertText">SOC OK</span></div>
    <div class="alertItem"><span class="dot" id="solarAlertDot"></span><span id="solarAlertText">Solar OK</span></div>
  </div>
  <main>
    <!-- Contenedor para barra de b√∫squeda y bot√≥n agregar -->
    <div class="header-actions">
      <!-- Barra de b√∫squeda -->
      <div id="searchBar">
        <input type="text" id="searchInput" placeholder="Buscar equipos por nombre, tipo, cliente...">
        <button id="searchClear">Limpiar</button>
      </div>
      
      <!-- Bot√≥n agregar equipo - Nueva posici√≥n -->
      <div class="add-button-container">
        <button id="addEquipoBtn" class="btn-success">‚ûï Agregar Equipo y Cliente</button>
      </div>
    </div>
    
    <!-- Panel de alertas colapsable - Solo visible en p√°gina principal -->
    <div id="alertasPanel">
      <div class="alertas-header" id="alertasHeader">
        <h3>üö® Alertas del Sistema</h3>
        <div class="alertas-indicador">
          <span class="alertas-badge" id="alertasBadge">0</span>
          <span class="alertas-toggle" id="alertasToggle">‚ñº</span>
        </div>
      </div>
      <div class="alertas-body" id="alertasBody">
        <div id="alertasContainer" class="alertas-grid">
          <!-- Las alertas se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </div>
    </div>
    
    <div id="noResults">
      <p>No se encontraron equipos que coincidan con tu b√∫squeda.</p>
    </div>
    
    <div id="selector"></div>
    
    <div id="dashboard">
      <!-- Resto del contenido del dashboard -->
      <div id="infoEquipo">
        <div class="left">
          <h2 id="tituloEquipo">Equipo</h2>
          <div id="estadoLinea" class="small"></div>
          <div id="clienteDetalle" class="cliente-detalle" style="display:none;">
            <!-- Aqu√≠ se mostrar√° la informaci√≥n del cliente -->
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="config small">
            <!-- Eliminamos los controles de SOC y DOD de aqu√≠ -->
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <div>
              <!-- Bot√≥n para abrir configuraci√≥n de suscripci√≥n -->
              <button id="configSuscripcionBtn">‚öôÔ∏è Configurar Suscripci√≥n</button>
            </div>
            <div>
              <button id="volver">Volver</button>
            </div>
          </div>
        </div>
      </div>
      <div id="summaryPanel" aria-live="polite">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="summaryItem"><small>Consumido (hoy)</small><div class="num" id="sumConsumed">-- kWh</div></div>
          <div class="summaryItem"><small>Generado Solar (hoy)</small><div class="num" id="sumSolar">-- kWh</div></div>
          <div class="summaryItem"><small>Importada / Inyectada</small><div class="num" id="sumGrid">-- / -- kWh</div></div>
          <div class="summaryItem"><small>Autoconsumo</small><div class="num" id="sumAuto">-- %</div></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div class="summaryStatus"><small>Estado general:</small><div id="summaryStatusDot" style="width:12px;height:12px;border-radius:50%;margin-left:8px;background:var(--alert-green)"></div></div>
          <div style="display:flex;gap:8px">
            <button id="btnVerResumen">Ver Resumen del D√≠a</button>
          </div>
        </div>
      </div>
      <div id="panelTiempoReal">
        <div class="dato" id="cardPotencia" data-type="potencia">
          <span class="real-time-badge" id="potenciaBadge" style="display:none">LIVE</span>
          <h3>Potencia Actual</h3><div class="valor" id="potencia">-- W</div>
        </div>
        <div class="dato" id="cardSolar" data-type="solar">
          <span class="real-time-badge" id="solarBadge" style="display:none">LIVE</span>
          <h3>Producci√≥n Solar</h3><div class="valor" id="produccionSolar">-- W</div>
        </div>
        <div class="dato" id="cardVoltPanels" data-type="voltPanels">
          <span class="real-time-badge" id="voltPanelsBadge" style="display:none">LIVE</span>
          <h3>Voltaje Paneles</h3><div class="valor" id="voltPanels">-- V</div>
        </div>
        <div class="dato" id="cardEnergiaRed" data-type="energiaRed"><h3>Energ√≠a de Red</h3><div class="valor" id="energiaRed">--</div></div>
        <div class="dato" id="cardAutoconsumo" data-type="autoconsumo"><h3>Autoconsumo Directo</h3><div class="valor" id="autoconsumo">-- W</div></div>
        <div class="dato" id="cardVoltBat" data-type="voltBatPack">
          <span class="real-time-badge" id="voltBatBadge" style="display:none">LIVE</span>
          <h3>Voltaje Bater√≠a</h3><div class="valor" id="voltajeBat">-- V</div>
        </div>
        <div class="dato" id="cardBateria" data-type="bateriaPct">
          <!-- Bot√≥n para mostrar/ocultar configuraci√≥n -->
          <button class="battery-config-toggle" id="batteryConfigToggle">‚öôÔ∏è</button>
          <span class="real-time-badge" id="bateriaBadge" style="display:none">LIVE</span>
          <h3>Porcentaje Bater√≠a</h3><div class="valor" id="bateriaPct">-- %</div>
          <!-- Configuraci√≥n SOC y DOD en la tarjeta de bater√≠a -->
          <div class="battery-config" id="batteryConfig">
            <div class="config-inputs">
              <div>
                <label for="socMaxInputCard">SOC m√°x (%):</label>
                <input id="socMaxInputCard" type="number" min="50" max="100" step="1" value="100">
              </div>
              <div>
                <label for="dodInputCard">DOD (%):</label>
                <input id="dodInputCard" type="number" min="5" max="80" step="1" value="20">
              </div>
            </div>
            <button class="config-btn" id="guardarSOCCard">Guardar</button>
          </div>
        </div>
        <div class="dato" id="cardTempInv" data-type="tempInv"><h3>Temperatura Inversor</h3><div class="valor" id="temperaturaInv">-- ¬∞C</div></div>
        <div class="dato"><h3>Estado Inversor</h3><div class="valor" id="estadoInv">--</div></div>
      </div>
      <div class="graficos">
        <div class="chart-container"><canvas id="historialDiario"></canvas><small>Consumo vs Producci√≥n (24h)</small></div>
        
        <div class="chart-container">
          <!-- Selectores para gr√°fico mensual -->
          <div class="chart-selectors">
            <div>
              <span class="chart-selector-label">A√±o:</span>
              <select id="selectAnoMensual" class="chart-selector">
                <!-- Opciones se llenar√°n din√°micamente -->
              </select>
            </div>
            <div>
              <span class="chart-selector-label">Mes:</span>
              <select id="selectMesMensual" class="chart-selector">
                <!-- Opciones se llenar√°n din√°micamente -->
              </select>
            </div>
          </div>
          <canvas id="historialMensual"></canvas>
          <small>Producci√≥n Mensual</small>
        </div>
        
        <div class="chart-container">
          <!-- Selector para gr√°fico anual -->
          <div class="chart-selectors">
            <div>
              <span class="chart-selector-label">A√±o:</span>
              <select id="selectAnoAnual" class="chart-selector">
                <!-- Opciones se llenar√°n din√°micamente -->
              </select>
            </div>
          </div>
          <canvas id="historialAnual"></canvas>
          <small>Producci√≥n Anual</small>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para mapa de ubicaci√≥n -->
  <div id="mapModal" class="overlay map-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="mapModalTitle">Ubicaci√≥n del Cliente</h2>
        <button class="close" id="closeMapModal">‚úï</button>
      </header>
      <section style="margin-top:12px">
        <div id="mapModalBody">
          <div id="mapContainer" class="map-container"></div>
          <div class="location-info">
            <div class="location-coords">
              <strong>Direcci√≥n:</strong> <span id="modalAddress"></span><br>
              <strong>Coordenadas:</strong> <span id="modalCoords"></span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal para gr√°fico flotante -->
  <div id="floatingChartModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="floatingChartTitle">Historial</h2>
        <button class="close" id="closeFloatingChartModal">‚úï</button>
      </header>
      <section style="margin-top:12px">
        <div class="chart-container">
          <canvas id="floatingChart"></canvas>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal para configuraci√≥n de suscripci√≥n -->
  <div id="suscripcionModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2>‚öôÔ∏è Configuraci√≥n de Suscripci√≥n</h2>
        <button class="close" id="closeSuscripcionModal">‚úï</button>
      </header>
      <section style="margin-top:12px">
        <div class="suscripcion-info">
          <h3 style="color:var(--accent); margin-bottom:10px;">Estado de Suscripci√≥n</h3>
          <div class="estado-suscripcion">
            <span>Estado actual:</span>
            <span id="estadoSuscripcion" class="badge badge-active">ACTIVO</span>
          </div>
          <div class="credito-display">
            <span id="creditoActual">30</span> d√≠as restantes
          </div>
          <p class="small">La suscripci√≥n controla el acceso a los datos del equipo. Cuando se agoten los d√≠as, el equipo se desactivar√° autom√°ticamente.</p>
        </div>
        
        <div class="suscripcion-controls">
          <input type="number" id="agregarDiasInput" min="1" value="1" style="width:60px;margin-right:8px;">
          <button id="agregarCreditoBtnNuevo" class="btn-success">+ d√≠as</button>
          <button id="quitarCreditoBtnNuevo">- d√≠as</button>
          <button id="toggleSuscripcionBtn" class="btn-success">Activar/Desactivar</button>
        </div>
        
        <div style="margin-top:20px; text-align:center;">
          <button id="cerrarSuscripcionBtn" class="close">Cerrar</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal para formulario de equipo y cliente -->
  <div id="formModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="modalFormTitle">Agregar Nuevo Equipo y Cliente</h2>
        <button class="close" id="closeFormModal">‚úï</button>
      </header>
      <form id="equipoForm">
        <div class="form-section">
          <h3>üìã Informaci√≥n del Equipo</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="nombreEquipo">Nombre del Equipo *</label>
              <input type="text" id="nombreEquipo" class="form-input" required placeholder="Ej: Sistema Solar Residencial">
            </div>
            <div class="form-group">
              <label class="form-label" for="consumoBase">Consumo Base (kW) *</label>
              <input type="number" id="consumoBase" class="form-input" min="1" max="50" step="0.1" required value="8">
            </div>
            <div class="form-group">
              <label class="form-label" for="tipoSistema">Tipo de Sistema</label>
              <select id="tipoSistema" class="form-select">
                <option value="residencial">Residencial</option>
                <option value="comercial">Comercial</option>
                <option value="industrial">Industrial</option>
                <option value="hibrido">H√≠brido</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="capacidadBateria">Capacidad Bater√≠a (kWh)</label>
              <input type="number" id="capacidadBateria" class="form-input" min="1" max="100" step="0.1" value="10">
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3>üë§ Informaci√≥n del Cliente</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="numeroCliente">N√∫mero de Cliente</label>
              <input type="text" id="numeroCliente" class="form-input" placeholder="CLI-001">
            </div>
            <div class="form-group">
              <label class="form-label" for="nombreCliente">Nombre Completo *</label>
              <input type="text" id="nombreCliente" class="form-input" required placeholder="Ej: Juan P√©rez Garc√≠a">
            </div>
            <div class="form-group">
              <label class="form-label" for="rutCliente">RUT *</label>
              <input type="text" id="rutCliente" class="form-input" required placeholder="12.345.678-9">
            </div>
            <div class="form-group">
              <label class="form-label" for="emailCliente">Email</label>
              <input type="email" id="emailCliente" class="form-input" placeholder="cliente@ejemplo.com">
            </div>
            <div class="form-group">
              <label class="form-label" for="telefonoCliente">Tel√©fono</label>
              <input type="tel" id="telefonoCliente" class="form-input" placeholder="+56 9 1234 5678">
            </div>
            <div class="form-group" style="grid-column: span 2;">
              <label class="form-label" for="direccionCliente">Direcci√≥n Completa *</label>
              <input type="text" id="direccionCliente" class="form-input" required placeholder="Calle Principal #123, Ciudad, Regi√≥n">
            </div>
            <!-- Secci√≥n de geolocalizaci√≥n -->
            <div class="form-group" style="grid-column: span 2;">
              <label class="form-label">Geolocalizaci√≥n</label>
              <div class="location-section">
                <div class="location-info">
                  <div class="location-coords">
                    <label class="form-label" for="latCliente">Latitud</label>
                    <input type="text" id="latCliente" class="form-input" placeholder="Ej: -33.4489" readonly>
                  </div>
                  <div class="location-coords">
                    <label class="form-label" for="lngCliente">Longitud</label>
                    <input type="text" id="lngCliente" class="form-input" placeholder="Ej: -70.6693" readonly>
                  </div>
                </div>
                <div class="location-actions">
                  <button type="button" id="geocodificarBtn" class="location-btn">üåç Obtener Coordenadas</button>
                  <button type="button" id="ubicacionActualBtn" class="location-btn">üìç Usar mi ubicaci√≥n</button>
                  <button type="button" id="limpiarCoordsBtn" class="location-btn">üóëÔ∏è Limpiar</button>
                </div>
                <div id="geocodingStatus" class="small" style="margin-top: 10px;"></div>
                <div id="currentLocation" class="location-current" style="display:none;">
                  <strong>Ubicaci√≥n actual detectada:</strong> <span id="currentCoords"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3>‚öôÔ∏è Configuraci√≥n Inicial</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="creditoInicial">Cr√©dito Inicial (d√≠as)</label>
              <input type="number" id="creditoInicial" class="form-input" min="1" max="365" value="30">
            </div>
            <div class="form-group">
              <label class="form-label" for="estadoInicial">Estado Inicial</label>
              <select id="estadoInicial" class="form-select">
                <option value="activo">Activo</option>
                <option value="inactivo">Inactivo</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="close" id="cancelForm">Cancelar</button>
          <button type="submit" class="btn-success">üíæ Guardar Equipo y Cliente</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para detalles (se mantiene igual) -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="modalTitle">Detalle</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="close" id="closeModal">Cerrar</button>
        </div>
      </header>
      <section id="modalBody" style="margin-top:12px"></section>
      <footer class="small" id="modalFooter"></footer>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // C√≥digo para la geolocalizaci√≥n con OpenStreetMap
    document.addEventListener('DOMContentLoaded', function() {
      // Variables globales para mapas
      let map;
      let miniMap;
      let marker;
      
      // Elementos del DOM
      const geocodificarBtn = document.getElementById('geocodificarBtn');
      const ubicacionActualBtn = document.getElementById('ubicacionActualBtn');
      const limpiarCoordsBtn = document.getElementById('limpiarCoordsBtn');
      const direccionInput = document.getElementById('direccionCliente');
      const latInput = document.getElementById('latCliente');
      const lngInput = document.getElementById('lngCliente');
      const geocodingStatus = document.getElementById('geocodingStatus');
      const currentLocation = document.getElementById('currentLocation');
      const currentCoords = document.getElementById('currentCoords');
      const mapModal = document.getElementById('mapModal');
      const closeMapModal = document.getElementById('closeMapModal');
      const mapContainer = document.getElementById('mapContainer');
      const modalAddress = document.getElementById('modalAddress');
      const modalCoords = document.getElementById('modalCoords');
      const mapModalTitle = document.getElementById('mapModalTitle');
      
      // Event listeners para geolocalizaci√≥n
      if (geocodificarBtn) {
        geocodificarBtn.addEventListener('click', geocodificarDireccion);
      }
      
      if (ubicacionActualBtn) {
        ubicacionActualBtn.addEventListener('click', obtenerUbicacionActual);
      }
      
      if (limpiarCoordsBtn) {
        limpiarCoordsBtn.addEventListener('click', limpiarCoordenadas);
      }
      
      if (closeMapModal) {
        closeMapModal.addEventListener('click', function() {
          mapModal.setAttribute('aria-hidden', 'true');
	  mapModal.style.display = 'none';
	
        });
      }
      
      // Funci√≥n para geocodificar direcci√≥n usando Nominatim (OpenStreetMap)
      function geocodificarDireccion() {
        const direccion = direccionInput.value.trim();
        
        if (!direccion) {
          mostrarEstadoGeocodificacion('Por favor, ingresa una direcci√≥n primero.', 'error');
          return;
        }
        
        mostrarEstadoGeocodificacion('Buscando coordenadas...', 'loading');
        geocodificarBtn.disabled = true;
        
        // Usar Nominatim (OpenStreetMap) para geocodificaci√≥n
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&limit=1`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
          })
          .then(data => {
            if (data && data.length > 0) {
              const result = data[0];
              latInput.value = result.lat;
              lngInput.value = result.lon;
              
              mostrarEstadoGeocodificacion('Coordenadas obtenidas correctamente.', 'success');
              
              // Mostrar informaci√≥n adicional si est√° disponible
              if (result.display_name) {
                mostrarEstadoGeocodificacion(`Ubicaci√≥n: ${result.display_name}`, 'info');
              }
            } else {
              mostrarEstadoGeocodificacion('No se pudo encontrar la ubicaci√≥n. Intenta con una direcci√≥n m√°s espec√≠fica.', 'error');
            }
          })
          .catch(error => {
            console.error('Error en geocodificaci√≥n:', error);
            mostrarEstadoGeocodificacion('Error al conectar con el servicio de geocodificaci√≥n.', 'error');
          })
          .finally(() => {
            geocodificarBtn.disabled = false;
          });
      }
      
      // Funci√≥n para obtener la ubicaci√≥n actual del usuario
      function obtenerUbicacionActual() {
        if (!navigator.geolocation) {
          mostrarEstadoGeocodificacion('La geolocalizaci√≥n no es compatible con este navegador.', 'error');
          return;
        }
        
        mostrarEstadoGeocodificacion('Obteniendo ubicaci√≥n actual...', 'loading');
        ubicacionActualBtn.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
          function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            latInput.value = lat;
            lngInput.value = lng;
            
            mostrarEstadoGeocodificacion('Ubicaci√≥n actual obtenida correctamente.', 'success');
            
            // Mostrar coordenadas actuales
            currentLocation.style.display = 'block';
            currentCoords.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            // Intentar obtener la direcci√≥n a partir de las coordenadas (geocodificaci√≥n inversa)
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
              .then(response => response.json())
              .then(data => {
                if (data && data.display_name) {
                  direccionInput.value = data.display_name;
                  mostrarEstadoGeocodificacion(`Direcci√≥n detectada: ${data.display_name}`, 'info');
                }
              })
              .catch(error => {
                console.error('Error en geocodificaci√≥n inversa:', error);
              });
          },
          function(error) {
            let mensaje = 'Error al obtener la ubicaci√≥n: ';
            switch(error.code) {
              case error.PERMISSION_DENIED:
                mensaje += 'Permiso denegado por el usuario.';
                break;
              case error.POSITION_UNAVAILABLE:
                mensaje += 'La informaci√≥n de ubicaci√≥n no est√° disponible.';
                break;
              case error.TIMEOUT:
                mensaje += 'Tiempo de espera agotado.';
                break;
              default:
                mensaje += 'Error desconocido.';
            }
            mostrarEstadoGeocodificacion(mensaje, 'error');
          }
        ).finally(() => {
          ubicacionActualBtn.disabled = false;
        });
      }
      
      // Funci√≥n para limpiar coordenadas
      function limpiarCoordenadas() {
        latInput.value = '';
        lngInput.value = '';
        currentLocation.style.display = 'none';
        mostrarEstadoGeocodificacion('Coordenadas limpiadas.', 'info');
      }
      
      // Funci√≥n auxiliar para mostrar estados de geocodificaci√≥n
      function mostrarEstadoGeocodificacion(mensaje, tipo) {
        geocodingStatus.textContent = mensaje;
        
        // Limpiar clases anteriores
        geocodingStatus.className = 'small';
        
        // A√±adir clase seg√∫n el tipo
        switch(tipo) {
          case 'success':
            geocodingStatus.style.color = 'var(--alert-green)';
            break;
          case 'error':
            geocodingStatus.style.color = 'var(--alert-red)';
            break;
          case 'loading':
            geocodingStatus.style.color = 'var(--accent)';
            break;
          case 'info':
            geocodingStatus.style.color = 'var(--text-secondary)';
            break;
        }
      }
      
      // Funci√≥n para inicializar mapa con Leaflet
      function initMap(lat, lng, title) {
        // Limpiar mapa existente si hay uno
        if (map) {
          map.remove();
        }
        
        // Inicializar mapa
        map = L.map('mapContainer').setView([lat, lng], 15);
        
        // A√±adir capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // A√±adir marcador
        marker = L.marker([lat, lng]).addTo(map)
          .bindPopup(title || 'Ubicaci√≥n del cliente')
          .openPopup();
        
        // Actualizar informaci√≥n en el modal
        modalAddress.textContent = direccionInput.value || 'Direcci√≥n no disponible';
        modalCoords.textContent = `${lat}, ${lng}`;
      }
      
      // Funci√≥n para inicializar mini mapa en la tarjeta del cliente
      function initMiniMap(containerId, lat, lng, title) {
        // Limpiar mini mapa existente si hay uno
        if (miniMap) {
          miniMap.remove();
        }
        
        // Inicializar mini mapa
        miniMap = L.map(containerId).setView([lat, lng], 13);
        
        // A√±adir capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(miniMap);
        
        // A√±adir marcador
        L.marker([lat, lng]).addTo(miniMap)
          .bindPopup(title || 'Ubicaci√≥n del cliente');
      }
      
      // Funci√≥n para abrir modal de mapa
      window.mostrarMapaUbicacion = function(cliente) {
        // Asegura que los valores sean num√©ricos y no vac√≠os
        if (!cliente.lat || !cliente.lng || isNaN(parseFloat(cliente.lat)) || isNaN(parseFloat(cliente.lng))) {
          alert('No hay coordenadas de ubicaci√≥n para este cliente.');
          return;
        }
        mapModalTitle.textContent = `Ubicaci√≥n: ${cliente.nombre || 'Cliente'}`;
        mapModal.setAttribute('aria-hidden', 'false');
        // Forzar mostrar el modal (por si usas display: none)
        mapModal.style.display = 'flex';
        // Inicializar el mapa despu√©s de que el modal est√© visible
        setTimeout(() => {
          initMap(parseFloat(cliente.lat), parseFloat(cliente.lng), cliente.nombre);
        }, 100);
      };
      
      // Modificar la funci√≥n mostrarDetallesCliente para incluir mapa en la tarjeta
      const mostrarDetallesClienteOriginal = window.mostrarDetallesCliente;
      if (typeof mostrarDetallesClienteOriginal === 'function') {
        window.mostrarDetallesCliente = function(cliente) {
          mostrarDetallesClienteOriginal(cliente);
          
          // Agregar informaci√≥n de ubicaci√≥n al detalle del cliente
          const clienteDetalle = document.getElementById('clienteDetalle');
          if (clienteDetalle) {
            // Eliminar cualquier mapa anterior
            const existingMap = document.getElementById('miniMap');
            if (existingMap) {
              existingMap.remove();
            }
            
            const locationInfo = document.createElement('div');
            locationInfo.className = 'client-location';
            
            if (cliente.lat && cliente.lng) {
              locationInfo.innerHTML = `
                <div class="client-map-header">
                  <strong>üìç Ubicaci√≥n del Cliente</strong>
                  <button class="view-map-btn" onclick="mostrarMapaUbicacion(${JSON.stringify(cliente).replace(/"/g, '&quot;')})">
                    Ver mapa completo
                  </button>
                </div>
                <div class="location-coordinates">
                  <strong>Direcci√≥n:</strong> ${cliente.direccion || 'No especificada'}<br>
                  <strong>Coordenadas:</strong> ${cliente.lat}, ${cliente.lng}
                </div>
                <div id="miniMap" class="mini-map-container"></div>
              `;
              
              clienteDetalle.appendChild(locationInfo);
              
              // Inicializar el mini mapa despu√©s de un breve retraso para asegurar que el contenedor est√© visible
              setTimeout(() => {
                if (document.getElementById('miniMap')) {
                  initMiniMap('miniMap', parseFloat(cliente.lat), parseFloat(cliente.lng), cliente.nombre);
                }
              }, 300);
            } else {
              locationInfo.innerHTML = `
                <div class="no-location-message">
                  <strong>üìç Ubicaci√≥n:</strong> No hay datos de ubicaci√≥n registrados para este cliente.
                  <div class="small" style="margin-top: 5px;">
                    Puedes agregar coordenadas editando la informaci√≥n del cliente.
                  </div>
                </div>
              `;
              clienteDetalle.appendChild(locationInfo);
            }
          }
        };
      }
      
      // Modificar la funci√≥n de guardar equipo para incluir coordenadas
      document.getElementById('equipoForm').addEventListener('submit', function(e) {
        // Elimina este bloque personalizado:
        /*
        e.preventDefault();
        // Recoger datos del formulario incluyendo coordenadas
        const equipoData = {
          // ...campos...
        };
        if (typeof window.guardarEquipo === 'function') {
          window.guardarEquipo(equipoData);
        } else {
          // Funci√≥n de respaldo si no existe la funci√≥n original
          console.log('Datos del equipo:', equipoData);
          alert('Equipo guardado (funci√≥n simulada). Revisa la consola para ver los datos.');
          document.getElementById('formModal').setAttribute('aria-hidden', 'true');
        }
        */
        // ...deja que el submit normal del sistema maneje el guardado...
      });
    });
  </script>
</body>
</html>
<!-- El mapa est√° correctamente implementado con Leaflet y OpenStreetMap -->
