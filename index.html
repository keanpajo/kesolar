<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EnergyControl ‚Äî Dashboard Final</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>üîã ENERGYCONTROL ‚Äî Dashboard Final</header>
  
  <!-- Alerta de conexi√≥n -->
  <div id="conexionAlert">
    <div class="conexion-alert-icon">‚ö†Ô∏è</div>
    <div class="conexion-alert-content">
      <strong id="conexionAlertTitle">Problema de conexi√≥n</strong>
      <div id="conexionAlertMessage">No se pueden obtener datos del servidor Arduino</div>
    </div>
    <button class="conexion-alert-close" id="conexionAlertClose">‚úï</button>
  </div>
  
  <div id="alertBar" aria-live="polite" style="display: none;">
    <div class="alertItem"><span class="dot green" id="alertOverallDot"></span><strong id="alertOverallText">NORMAL</strong></div>
    <div class="alertItem"><span class="dot" id="cellAlertDot"></span><span id="cellAlertText">Celdas OK</span></div>
    <div class="alertItem"><span class="dot" id="tempAlertDot"></span><span id="tempAlertText">Temp OK</span></div>
    <div class="alertItem"><span class="dot" id="socAlertDot"></span><span id="socAlertText">SOC OK</span></div>
    <div class="alertItem"><span class="dot" id="solarAlertDot"></span><span id="solarAlertText">Solar OK</span></div>
  </div>
  <main>
    <!-- Contenedor para barra de b√∫squeda y bot√≥n agregar -->
    <div class="header-actions">
      <!-- Barra de b√∫squeda -->
      <div id="searchBar">
        <input type="text" id="searchInput" placeholder="Buscar equipos por nombre, tipo, cliente...">
        <button id="searchClear">Limpiar</button>
      </div>
      
      <!-- Bot√≥n agregar equipo - Nueva posici√≥n -->
      <div class="add-button-container">
        <button id="addEquipoBtn" class="btn-success">‚ûï Agregar Equipo y Cliente</button>
      </div>
    </div>
    
    <!-- Panel de alertas colapsable - Solo visible en p√°gina principal -->
    <div id="alertasPanel">
      <div class="alertas-header" id="alertasHeader">
        <h3>üö® Alertas del Sistema</h3>
        <div class="alertas-indicador">
          <span class="alertas-badge" id="alertasBadge">0</span>
          <span class="alertas-toggle" id="alertasToggle">‚ñº</span>
        </div>
      </div>
      <div class="alertas-body" id="alertasBody">
        <div id="alertasContainer" class="alertas-grid">
          <!-- Las alertas se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </div>
    </div>
    
    <div id="noResults">
      <p>No se encontraron equipos que coincidan con tu b√∫squeda.</p>
    </div>
    
    <div id="selector"></div>
    
    <div id="dashboard">
      <!-- Resto del contenido del dashboard -->
      <div id="infoEquipo">
        <div class="left">
          <h2 id="tituloEquipo">Equipo</h2>
          <div id="estadoLinea" class="small"></div>
          <div id="clienteDetalle" class="cliente-detalle" style="display:none;">
            <!-- Aqu√≠ se mostrar√° la informaci√≥n del cliente -->
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="config small">
            <!-- Eliminamos los controles de SOC y DOD de aqu√≠ -->
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <div>
              <!-- Bot√≥n para abrir configuraci√≥n de suscripci√≥n -->
              <button id="configSuscripcionBtn">‚öôÔ∏è Configurar Suscripci√≥n</button>
            </div>
            <div>
              <button id="volver">Volver</button>
            </div>
          </div>
        </div>
      </div>
      <div id="summaryPanel" aria-live="polite">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="summaryItem"><small>Consumido (hoy)</small><div class="num" id="sumConsumed">-- kWh</div></div>
          <div class="summaryItem"><small>Generado Solar (hoy)</small><div class="num" id="sumSolar">-- kWh</div></div>
          <div class="summaryItem"><small>Importada / Inyectada</small><div class="num" id="sumGrid">-- / -- kWh</div></div>
          <div class="summaryItem"><small>Autoconsumo</small><div class="num" id="sumAuto">-- %</div></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div class="summaryStatus"><small>Estado general:</small><div id="summaryStatusDot" style="width:12px;height:12px;border-radius:50%;margin-left:8px;background:var(--alert-green)"></div></div>
          <div style="display:flex;gap:8px">
            <button id="btnVerResumen">Ver Resumen del D√≠a</button>
          </div>
        </div>
      </div>
      <div id="panelTiempoReal">
        <div class="dato" id="cardPotencia" data-type="potencia">
          <span class="real-time-badge" id="potenciaBadge" style="display:none">LIVE</span>
          <h3>Potencia Actual</h3><div class="valor" id="potencia">-- W</div>
        </div>
        <div class="dato" id="cardSolar" data-type="solar">
          <span class="real-time-badge" id="solarBadge" style="display:none">LIVE</span>
          <h3>Producci√≥n Solar</h3><div class="valor" id="produccionSolar">-- W</div>
        </div>
        <div class="dato" id="cardVoltPanels" data-type="voltPanels">
          <span class="real-time-badge" id="voltPanelsBadge" style="display:none">LIVE</span>
          <h3>Voltaje Paneles</h3><div class="valor" id="voltPanels">-- V</div>
        </div>
        <div class="dato" id="cardEnergiaRed" data-type="energiaRed"><h3>Energ√≠a de Red</h3><div class="valor" id="energiaRed">--</div></div>
        <div class="dato" id="cardAutoconsumo" data-type="autoconsumo"><h3>Autoconsumo Directo</h3><div class="valor" id="autoconsumo">-- W</div></div>
        <div class="dato" id="cardVoltBat" data-type="voltBatPack">
          <span class="real-time-badge" id="voltBatBadge" style="display:none">LIVE</span>
          <h3>Voltaje Bater√≠a</h3><div class="valor" id="voltajeBat">-- V</div>
        </div>
        <div class="dato" id="cardBateria" data-type="bateriaPct">
          <!-- Bot√≥n para mostrar/ocultar configuraci√≥n -->
          <button class="battery-config-toggle" id="batteryConfigToggle">‚öôÔ∏è</button>
          <span class="real-time-badge" id="bateriaBadge" style="display:none">LIVE</span>
          <h3>Porcentaje Bater√≠a</h3><div class="valor" id="bateriaPct">-- %</div>
          <!-- Configuraci√≥n SOC y DOD en la tarjeta de bater√≠a -->
          <div class="battery-config" id="batteryConfig">
            <div class="config-inputs">
              <div>
                <label for="socMaxInputCard">SOC m√°x (%):</label>
                <input id="socMaxInputCard" type="number" min="50" max="100" step="1" value="100">
              </div>
              <div>
                <label for="dodInputCard">DOD (%):</label>
                <input id="dodInputCard" type="number" min="5" max="80" step="1" value="20">
              </div>
            </div>
            <button class="config-btn" id="guardarSOCCard">Guardar</button>
          </div>
        </div>
        <div class="dato" id="cardTempInv" data-type="tempInv"><h3>Temperatura Inversor</h3><div class="valor" id="temperaturaInv">-- ¬∞C</div></div>
        <div class="dato"><h3>Estado Inversor</h3><div class="valor" id="estadoInv">--</div></div>
      </div>
      <div class="graficos">
        <div class="chart-container"><canvas id="historialDiario"></canvas><small>Consumo vs Producci√≥n (24h)</small></div>
        
        <div class="chart-container">
          <!-- Selectores para gr√°fico mensual -->
          <div class="chart-selectors">
            <div>
              <span class="chart-selector-label">A√±o:</span>
              <select id="selectAnoMensual" class="chart-selector">
                <!-- Opciones se llenar√°n din√°micamente -->
              </select>
            </div>
            <div>
              <span class="chart-selector-label">Mes:</span>
              <select id="selectMesMensual" class="chart-selector">
                <!-- Opciones se llenar√°n din√°micamente -->
              </select>
            </div>
          </div>
          <canvas id="historialMensual"></canvas>
          <small>Producci√≥n Mensual</small>
        </div>
        
        <div class="chart-container">
          <!-- Selector para gr√°fico anual -->
          <div class="chart-selectors">
            <div>
              <span class="chart-selector-label">A√±o:</span>
              <select id="selectAnoAnual" class="chart-selector">
                <!-- Opciones se llenar√°n din√°micamente -->
              </select>
            </div>
          </div>
          <canvas id="historialAnual"></canvas>
          <small>Producci√≥n Anual</small>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para gr√°fico flotante -->
  <div id="floatingChartModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="floatingChartTitle">Historial</h2>
        <button class="close" id="closeFloatingChartModal">‚úï</button>
      </header>
      <section style="margin-top:12px">
        <div class="chart-container">
          <canvas id="floatingChart"></canvas>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal para configuraci√≥n de suscripci√≥n -->
  <div id="suscripcionModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2>‚öôÔ∏è Configuraci√≥n de Suscripci√≥n</h2>
        <button class="close" id="closeSuscripcionModal">‚úï</button>
      </header>
      <section style="margin-top:12px">
        <div class="suscripcion-info">
          <h3 style="color:var(--accent); margin-bottom:10px;">Estado de Suscripci√≥n</h3>
          <div class="estado-suscripcion">
            <span>Estado actual:</span>
            <span id="estadoSuscripcion" class="badge badge-active">ACTIVO</span>
          </div>
          <div class="credito-display">
            <span id="creditoActual">30</span> d√≠as restantes
          </div>
          <p class="small">La suscripci√≥n controla el acceso a los datos del equipo. Cuando se agoten los d√≠as, el equipo se desactivar√° autom√°ticamente.</p>
        </div>
        
        <div class="suscripcion-controls">
          <button id="toggleSuscripcionBtn" class="btn-success">Activar/Desactivar</button>
          <button id="agregarCreditoBtn">+5 d√≠as</button>
          <button id="quitarCreditoBtn">-5 d√≠as</button>
        </div>
        
        <div style="margin-top:20px; text-align:center;">
          <button id="cerrarSuscripcionBtn" class="close">Cerrar</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal para formulario de equipo y cliente -->
  <div id="formModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="modalFormTitle">Agregar Nuevo Equipo y Cliente</h2>
        <button class="close" id="closeFormModal">‚úï</button>
      </header>
      <form id="equipoForm">
        <div class="form-section">
          <h3>üìã Informaci√≥n del Equipo</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="nombreEquipo">Nombre del Equipo *</label>
              <input type="text" id="nombreEquipo" class="form-input" required placeholder="Ej: Sistema Solar Residencial">
            </div>
            <div class="form-group">
              <label class="form-label" for="consumoBase">Consumo Base (kW) *</label>
              <input type="number" id="consumoBase" class="form-input" min="1" max="50" step="0.1" required value="8">
            </div>
            <div class="form-group">
              <label class="form-label" for="tipoSistema">Tipo de Sistema</label>
              <select id="tipoSistema" class="form-select">
                <option value="residencial">Residencial</option>
                <option value="comercial">Comercial</option>
                <option value="industrial">Industrial</option>
                <option value="hibrido">H√≠brido</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="capacidadBateria">Capacidad Bater√≠a (kWh)</label>
              <input type="number" id="capacidadBateria" class="form-input" min="1" max="100" step="0.1" value="10">
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3>üë§ Informaci√≥n del Cliente</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="numeroCliente">N√∫mero de Cliente</label>
              <input type="text" id="numeroCliente" class="form-input" placeholder="CLI-001">
            </div>
            <div class="form-group">
              <label class="form-label" for="nombreCliente">Nombre Completo *</label>
              <input type="text" id="nombreCliente" class="form-input" required placeholder="Ej: Juan P√©rez Garc√≠a">
            </div>
            <div class="form-group">
              <label class="form-label" for="rutCliente">RUT *</label>
              <input type="text" id="rutCliente" class="form-input" required placeholder="12.345.678-9">
            </div>
            <div class="form-group">
              <label class="form-label" for="emailCliente">Email</label>
              <input type="email" id="emailCliente" class="form-input" placeholder="cliente@ejemplo.com">
            </div>
            <div class="form-group">
              <label class="form-label" for="telefonoCliente">Tel√©fono</label>
              <input type="tel" id="telefonoCliente" class="form-input" placeholder="+56 9 1234 5678">
            </div>
            <div class="form-group" style="grid-column: span 2;">
              <label class="form-label" for="direccionCliente">Direcci√≥n Completa *</label>
              <input type="text" id="direccionCliente" class="form-input" required placeholder="Calle Principal #123, Ciudad, Regi√≥n">
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3>‚öôÔ∏è Configuraci√≥n Inicial</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="creditoInicial">Cr√©dito Inicial (d√≠as)</label>
              <input type="number" id="creditoInicial" class="form-input" min="1" max="365" value="30">
            </div>
            <div class="form-group">
              <label class="form-label" for="estadoInicial">Estado Inicial</label>
              <select id="estadoInicial" class="form-select">
                <option value="activo">Activo</option>
                <option value="inactivo">Inactivo</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="close" id="cancelForm">Cancelar</button>
          <button type="submit" class="btn-success">üíæ Guardar Equipo y Cliente</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para detalles (se mantiene igual) -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="modalTitle">Detalle</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="close" id="closeModal">Cerrar</button>
        </div>
      </header>
      <section id="modalBody" style="margin-top:12px"></section>
      <footer class="small" id="modalFooter"></footer>
    </div>
  </div>

  <script src="script.js"></script>
</body>
</html>
